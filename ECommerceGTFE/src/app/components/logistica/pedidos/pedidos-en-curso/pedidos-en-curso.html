<div class="orders-container">
    <div class="page-header">
        <h1>Gestion de Pedidos en Curso</h1>
    </div>    
    <div *ngIf="success" class="success-message">
        {{ success }}
    </div>
    <div *ngIf="error" class="error-message">
        {{ error }}
    </div>
    <div class="filters-card">
        <div class="filters-header">
            <h3>Filtros</h3>
            <button class="btn-clear" (click)="limpiarFiltros()">Limpiar filtros</button>
        </div>
        <div class="filters-grid">
            <div class="filter-group">
                <label class="filter-label">Buscar</label>
                <input type="text" [(ngModel)]="searchTerm" placeholder="Buscar por cliente, dirección o ID compra"
                    class="filter-input">
            </div>
        </div>
    </div>
    <div class="orders-card">
        <div *ngIf="!isLoading && !error">
            <div *ngIf="entregasFiltradas.length > 0" class="orders-grid">
                <div *ngFor="let entrega of entregasFiltradas" class="order-card">
                    <div class="order-header">
                        <div class="order-info">
                            <h3 class="order-id">Pedido NO. {{ entrega.compraId }}</h3>
                        </div>
                        <div>
                            {{ formatearPrecio(entrega.compraTotal) }}
                        </div>
                    </div>                    
                    <div class="customer-info">
                        <div class="info-item">
                            <strong>Cliente:</strong> {{ entrega.usuarioNombre }}
                        </div>
                        <div class="info-item">
                            <strong>Direccion:</strong> {{ entrega.usuarioDireccion }}
                        </div>
                        <div class="info-item">
                            <strong>Fecha estimada:</strong> {{ entrega.fechaEstimada }}
                        </div>
                    </div>
                    <div class="order-items-section">
                        <h4 class="items-title">Articulos en la compra:</h4>

                        <div class="items-list">
                            <div *ngFor="let detalle of entrega.detalles || []" 
                                 class="item-row" 
                                 [class.item-ready]="detalle.listo">
                                <div class="item-info">
                                    <div class="item-details">
                                        <h5 class="item-name">{{ detalle.articuloNombre }}</h5>
                                        <p class="item-quantity">cantidad: {{ detalle.cantidad }}</p>
                                    </div>
                                </div>
                                
                                <div>
                                    <span *ngIf="detalle.listo">Listo</span>
                                    <button *ngIf="!detalle.listo" 
                                            (click)="marcarDetalleListo(detalle, entrega.id)"
                                            class="btn btn-primary">
                                        Marcar como Listo
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="order-actions">
                        <button class="btn-update-date" (click)="abrirModalFecha(entrega)">
                            Modificar Fecha
                        </button>
                        <button class="btn-deliver" 
                                (click)="marcarComoEntregada(entrega)"
                                [disabled]="!todosDetallesListos(entrega.detalles || [])"
                                [class.disabled]="!todosDetallesListos(entrega.detalles || [])"
                                title="{{ todosDetallesListos(entrega.detalles || []) ? 'Marcar entrega como entregada' : 'Todos los artículos deben estar listos' }}">
                            {{ todosDetallesListos(entrega.detalles || []) ? 'Marcar Entregado' : 'Esperando artículos (' + contarDetallesListos(entrega.detalles) + '/' + (entrega.detalles?.length || 0) + ')' }}
                        </button>
                    </div>
                </div>
            </div>
            <div *ngIf="entregasFiltradas.length === 0 && !isLoading" class="empty-state">
                <h3>No hay pedidos en curso</h3>
            </div>
        </div>
    </div>
</div>

<div *ngIf="showDateModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Modificar Fecha de Entrega</h3>
            <button class="modal-close" (click)="cerrarModalFecha()">×</button>
        </div>
        <div class="modal-body">
            <p>Selecciona la nueva fecha estimada de entrega para el pedido #{{ selectedEntrega?.compraId }}</p>
            <div class="form-group">
                <label class="form-label">Nueva Fecha Estimada</label>
                <input type="date" [(ngModel)]="newFechaEstimada" class="form-input">
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn-cancel" (click)="cerrarModalFecha()">Cancelar</button>
            <button class="btn-confirm" (click)="actualizarFechaEstimada()">Actualizar Fecha</button>
        </div>
    </div>
</div>