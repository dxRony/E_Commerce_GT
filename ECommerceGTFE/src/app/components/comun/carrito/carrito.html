<div *ngIf="mostrarAlerta" class="notification-alert">
    <div class="alert-content">
        <span class="alert-message">{{ mensajeAlerta }}</span>
    </div>
</div>

<div *ngIf="mostrarModalPago" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Procesar Pago</h2>
            <button (click)="cerrarModalPago()" class="modal-close-btn">×</button>
        </div>

        <div class="modal-body">
            <div class="resumen-compra">
                <h3 class="resumen-title">Resumen de Compra</h3>
                <div class="resumen-total">
                    <span>Total a pagar:</span>
                    <span class="total-amount">{{ formatearPrecio(carrito?.totalPrecio || 0) }}</span>
                </div>
                <p class="resumen-items">{{ carrito?.totalDetalles }} productos</p>
            </div>

            <div class="seleccion-tarjeta">
                <h3 class="seccion-title">Seleccionar Tarjeta</h3>

                <div *ngIf="!mostrarFormTarjeta" class="tarjetas-lista">
                    <div *ngFor="let tarjeta of tarjetas" class="tarjeta-item"
                        [class.selected]="tarjetaSeleccionada === tarjeta.id"
                        (click)="tarjetaSeleccionada = tarjeta.id">
                        <div class="tarjeta-info">
                            <span class="tarjeta-numero">{{ ocutlarNumeroTarjeta(tarjeta.numeracion) }}</span>
                            <span class="tarjeta-vencimiento">Vence: {{ tarjeta.fechaVencimiento }}</span>
                        </div>
                        <div class="tarjeta-check">
                            <div class="check-icon" *ngIf="tarjetaSeleccionada === tarjeta.id">✓</div>
                        </div>
                    </div>
                    <button (click)="mostrarFormTarjeta = true" class="btn-agregar-tarjeta">
                        Agregar Nueva Tarjeta
                    </button>
                </div>

                <div *ngIf="mostrarFormTarjeta" class="form-tarjeta">
                    <h4 class="form-title">Agregar Nueva Tarjeta</h4>
                    <div class="form-group">
                        <label class="form-label">Numero de Tarjeta (16-19 digitos)</label>
                        <input type="number" [(ngModel)]="nuevaTarjeta.numeracion" class="form-input" maxlength="19">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Fecha de Vencimiento</label>
                            <input type="date" [(ngModel)]="nuevaTarjeta.fechaVencimiento" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">CVV (3-4 digitos)</label>
                            <input type="number" [(ngModel)]="nuevaTarjeta.cvv" class="form-input" maxlength="4">
                        </div>
                    </div>
                    <div class="form-actions">
                        <button (click)="mostrarFormTarjeta = false" class="btn-cancelar">
                            Cancelar
                        </button>
                        <button (click)="agregarNuevaTarjeta()" class="btn-guardar">
                            Guardar Tarjeta
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button (click)="cerrarModalPago()" class="btn-cancelar">
                Cancelar
            </button>
            <button (click)="procesarPago()" [disabled]="!tarjetaSeleccionada || procesandoPago" class="btn-pagar"
                [class.loading]="procesandoPago">
                <span *ngIf="!procesandoPago">Pagar {{ formatearPrecio(carrito?.totalPrecio || 0) }}</span>
                <span *ngIf="procesandoPago">Procesando...</span>
            </button>
        </div>
    </div>
</div>

<div class="carrito-container">
    <div class="carrito-content">
        <div class="carrito-header">
            <h1 class="carrito-title">Carrito de Compras</h1>
        </div>
        <div *ngIf="!isLoading && !error && (!carrito || carrito.detalles.length === 0)">
            <h3>Tu carrito esta vacio</h3>
        </div>
        <div *ngIf="!isLoading && !error && carrito && carrito.detalles.length > 0" class="cart-with-items">
            <div class="cart-items-section">
                <div class="cart-items-header">
                    <h2 class="cart-items-title">
                        Productos en el carrito ({{ carrito.totalDetalles }})
                    </h2>
                    <button (click)="limpiarCarrito()">
                        Limpiar Carrito
                    </button>
                </div>
                <div class="cart-table-container">
                    <table class="cart-table">
                        <thead class="table-header">
                            <tr>
                                <th class="table-header-cell">Producto</th>
                                <th class="table-header-cell">Precio</th>
                                <th class="table-header-cell">Cantidad</th>
                                <th class="table-header-cell">Subtotal</th>
                                <th class="table-header-cell">Acciones</th>
                            </tr>
                        </thead>
                        <tbody class="table-body">
                            <tr *ngFor="let item of carrito.detalles" class="table-row">
                                <td class="table-cell product-cell">
                                    <div class="product-info">
                                        <div class="product-details">
                                            <h3 class="product-name">{{ item.articuloNombre }}</h3>
                                            <p class="stock-info">
                                                Stock disponible: {{ item.stockDisponible }}
                                            </p>
                                        </div>
                                    </div>
                                </td>
                                <td class="table-cell price-cell">
                                    <div class="price-amount">
                                        {{ formatearPrecio(item.articuloPrecio) }}
                                    </div>
                                </td>
                                <td class="table-cell quantity-cell">
                                    <div class="quantity-controls">
                                        <button (click)="actualizarCantidad(item, item.cantidad - 1)"
                                            class="quantity-btn">
                                            -
                                        </button>
                                        <span class="quantity-display">{{ item.cantidad }}</span>
                                        <button (click)="actualizarCantidad(item, item.cantidad + 1)"
                                            [disabled]="item.cantidad >= item.stockDisponible" class="quantity-btn"
                                            [class.disabled]="item.cantidad >= item.stockDisponible">
                                            +
                                        </button>
                                    </div>
                                </td>
                                <td class="table-cell subtotal-cell">
                                    <div class="subtotal-amount">
                                        {{ formatearPrecio(item.articuloPrecio * item.cantidad) }}
                                    </div>
                                </td>
                                <td class="table-cell actions-cell">
                                    <button (click)="eliminarDelCarrito(item.id)">
                                        Eliminar
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="cart-summary">
                <div class="summary-content">
                    <div class="total-info">
                        <p class="total-amount">
                            Total: {{ formatearPrecio(carrito.totalPrecio) }}
                        </p>
                    </div>
                    <div class="summary-actions">
                        <a routerLink="/comun/articulos-disponibles">
                            Agregar mas productos
                        </a>
                        <button (click)="abrirModalPago()" class="">
                            Proceder al Pago
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>